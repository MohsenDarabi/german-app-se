var f=Object.defineProperty;var S=(d,s,t)=>s in d?f(d,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[s]=t;var w=(d,s,t)=>S(d,typeof s!="symbol"?s+"":s,t);import{d as i}from"./index.lHhEmOCy.js";import{s as l}from"./client.M3ojON4v.js";class h{constructor(){w(this,"syncInProgress",!1);w(this,"lastSyncTimestamp",null);w(this,"syncIntervalId",null);if(typeof window<"u"){const s=localStorage.getItem("lastSyncTimestamp");this.lastSyncTimestamp=s?new Date(s):null}}async sync(){if(this.syncInProgress){console.log("[SyncEngine] Sync already in progress, skipping...");return}try{this.syncInProgress=!0,console.log("[SyncEngine] Starting sync...");const{data:{user:s}}=await l.auth.getUser();if(!s){console.log("[SyncEngine] No authenticated user, skipping sync");return}await this.pushLocalChanges(s.id),await this.pullCloudChanges(s.id),this.lastSyncTimestamp=new Date,typeof window<"u"&&localStorage.setItem("lastSyncTimestamp",this.lastSyncTimestamp.toISOString()),console.log("[SyncEngine] Sync completed successfully")}catch(s){console.error("[SyncEngine] Sync error:",s)}finally{this.syncInProgress=!1}}async pushLocalChanges(s){console.log("[SyncEngine] Pushing local changes to cloud...");try{const t=await i.users.get(1);if(t){const{error:a}=await l.from("users").upsert({id:s,email:t.email,name:t.name,xp:t.xp,streak:t.streak,last_study_date:t.lastStudyDate,total_study_minutes:t.totalStudyMinutes});a&&console.error("[SyncEngine] Error syncing user:",a)}const u=await i.lessonProgress.toArray();if(u.length>0){const a=u.map(n=>({user_id:s,lesson_id:n.lessonId,status:n.status,current_step_index:n.currentStepIndex,score:n.score,completed_at:n.completedAt?new Date(n.completedAt):null,updated_at:new Date(n.updatedAt)})),{error:c}=await l.from("lesson_progress").upsert(a,{onConflict:"user_id,lesson_id"});c&&console.error("[SyncEngine] Error syncing lesson progress:",c)}const r=await i.vocab.toArray();if(r.length>0){const a=r.map(n=>({user_id:s,word:n.word,translation:n.translation,example:n.example||null,added_at:n.addedAt,next_review:n.nextReview||null,srs_level:n.srsLevel||0})),{error:c}=await l.from("vocab_items").upsert(a);c&&console.error("[SyncEngine] Error syncing vocab:",c)}const g=await i.wrongAnswers.toArray();if(g.length>0){const a=g.map(n=>({user_id:s,lesson_id:n.lessonId,step_id:n.stepId,step_type:n.stepType,question:n.question,user_answer:n.userAnswer,correct_answer:n.correctAnswer,reviewed_at:n.reviewedAt?new Date(n.reviewedAt):null})),{error:c}=await l.from("wrong_answers").upsert(a);c&&console.error("[SyncEngine] Error syncing wrong answers:",c)}console.log("[SyncEngine] Push completed")}catch(t){throw console.error("[SyncEngine] Error during push:",t),t}}async pullCloudChanges(s){var t,u;console.log("[SyncEngine] Pulling cloud changes to local...");try{const{data:r,error:g}=await l.from("users").select("*").eq("id",s).single();r&&!g&&await i.users.put({id:1,email:r.email,name:r.name,xp:r.xp,streak:r.streak,lastStudyDate:r.last_study_date,totalStudyMinutes:r.total_study_minutes});const{data:a,error:c}=await l.from("lesson_progress").select("*").eq("user_id",s);if(a&&!c)for(const e of a){const o=await i.lessonProgress.where("lessonId").equals(e.lesson_id).first();(!o||new Date(e.updated_at)>new Date(o.updatedAt))&&await i.lessonProgress.put({id:o==null?void 0:o.id,lessonId:e.lesson_id,status:e.status,currentStepIndex:e.current_step_index,score:e.score,completedAt:(t=e.completed_at)==null?void 0:t.toString(),updatedAt:e.updated_at.toString()})}const{data:n,error:p}=await l.from("vocab_items").select("*").eq("user_id",s);if(n&&!p)for(const e of n){const o=await i.vocab.where("word").equals(e.word).first();(!o||new Date(e.updated_at)>new Date(o.addedAt))&&await i.vocab.put({id:o==null?void 0:o.id,word:e.word,translation:e.translation,example:e.example||void 0,addedAt:new Date(e.added_at),nextReview:e.next_review?new Date(e.next_review):void 0,srsLevel:e.srs_level})}const{data:y,error:m}=await l.from("wrong_answers").select("*").eq("user_id",s);if(y&&!m)for(const e of y)await i.wrongAnswers.where(["lessonId","stepId"]).equals([e.lesson_id,e.step_id]).first()||await i.wrongAnswers.add({lessonId:e.lesson_id,stepId:e.step_id,stepType:e.step_type,question:e.question,userAnswer:e.user_answer,correctAnswer:e.correct_answer,reviewedAt:(u=e.reviewed_at)==null?void 0:u.toString()});console.log("[SyncEngine] Pull completed")}catch(r){throw console.error("[SyncEngine] Error during pull:",r),r}}startBackgroundSync(){typeof window>"u"||(console.log("[SyncEngine] Starting background sync..."),this.syncIntervalId=window.setInterval(()=>{this.sync()},3e4),document.addEventListener("visibilitychange",()=>{document.hidden||this.sync()}),window.addEventListener("online",()=>{console.log("[SyncEngine] Connection restored, syncing..."),this.sync()}),window.addEventListener("offline",()=>{console.log("[SyncEngine] Connection lost, will sync when restored")}))}stopBackgroundSync(){this.syncIntervalId!==null&&(clearInterval(this.syncIntervalId),this.syncIntervalId=null,console.log("[SyncEngine] Background sync stopped"))}getLastSyncTime(){return this.lastSyncTimestamp}isSyncing(){return this.syncInProgress}}const I=new h;export{I as s};
